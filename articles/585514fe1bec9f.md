---
title: "Heftiaã®ä»•çµ„ã¿"
emoji: "ğŸ’¬"
type: "tech"
topics: []
published: false
---

# ã¯ã˜ã‚ã«
 æœ¬è¨˜äº‹ã¯

* å¤šç›¸å‹ã‚·ã‚¹ãƒ†ãƒ 
    * ç‰¹ã«é‡åŒ–å­$\forall$/$\exist$ã€ãã‚Œã‚’ä½¿ç”¨ã—ã¦å®šç¾©ã•ã‚Œã‚‹å‹ã®ç­‰ä¾¡ãªå¤‰å½¢ã€åœè«–ã£ã½ã„æ„Ÿã˜ã®å‹è¡¨è¨˜[^2]
* ãƒ‡ãƒ¼ã‚¿å‹ã®å¸°ç´çš„å®šç¾©ï¼ˆã„ã‚ã‚†ã‚‹GADTï¼‰ã€ä¸å‹•ç‚¹æ¼”ç®—å­
* Extensible Effects (Freer Effects) ã®å¤§ã¾ã‹ãªä»•çµ„ã¿

ã®çŸ¥è­˜ã‚’å‰æã«ã—ã¦ã„ã¾ã™ã€‚Extensible Effectsã«ã¤ã„ã¦ã¯ã€[Freer EffectsãŒã€ã ã„ãŸã„ã‚ã‹ã£ãŸ](https://qiita.com/YoshikuniJujo/items/c71644b5af1f5195cbf3)ã®ã‚·ãƒªãƒ¼ã‚ºãŒç†è§£ã«ãŠã™ã™ã‚ã§ã™ã€‚ãªãŠæœ¬è¨˜äº‹ã§ã¯Freer Effectsã¨Extensible Effectsã‚’ç‰¹ã«åŒºåˆ¥ã›ãšä½¿ã„ã¾ã™ã€‚

[^2]: $F[G,-]$ã¿ãŸã„ãªã‚„ã¤ã®ã“ã¨ã§ã™ã€‚$F$ã¨ã„ã†2å¼•æ•°ã®å‹ãƒ¬ãƒ™ãƒ«ã®é–¢æ•°ã®ç¬¬1å¼•æ•°ã«$G$ã‚’ä»£å…¥ã—ã¦ç¬¬2å¼•æ•°ã‚’å…¨ä½“ã¨ã—ã¦ã®æ–°ãŸãªå¼•æ•°ã«ã—ã¦ã„ã‚‹ã¨ã„ã†ã“ã¨ãŒã“ã“ã‹ã‚‰èª­ã¿å–ã‚Œã‚Œã°ååˆ†ã§ã™ã€‚ç­†è€…ã¯åœè«–ã‚’ã‚ˆãçŸ¥ã‚Šã¾ã›ã‚“ã€‚

# Extensible Effectsã®ãŠã•ã‚‰ã„
Freerã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ã—ã¦å®šç¾©ã•ã‚Œã‚‹ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã§ã™:

* å¸°ç´çš„å®šç¾©

    $$\begin{aligned}
    & \mathrm{Freer}[F,A] \  \mathrm{where} \\\
    & \quad \mathrm{return} : \{ \mathrm{returnValue}: A \} \rightarrow \mathrm{Freer}[F,A] \\\
    & \quad \mathrm{freer} : \big( \exist X. \{ \mathrm{freerEffect}: F[X], \mathrm{resume}: X \rightarrow \mathrm{Freer}[F,A] \} \big) \rightarrow \mathrm{Freer}[F,A]
    \end{aligned}
    $$

* ä¸å‹•ç‚¹ã«ã‚ˆã‚‹å®šç¾©

    $$
    \mathrm{Freer}[F,A] := \mathrm{fix} \ \alpha. \ A + \exist X. \big( F[X] \times (X \rightarrow \alpha) \big)
    $$

ã“ã‚Œã‚’Haskellã§æ›¸ãã¨[^1]

```haskell
data Freer f a =
      Return { returnValue :: a }
    | forall x. Freer { freerEffect :: f x, resume :: x -> Freer f a }
```

[^1]: Haskellã ã¨å­˜åœ¨å‹ã«ã‚‚`forall`ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ä½¿ã†ã®ã§åˆ†ã‹ã‚Šã¥ã‚‰ã„ã§ã™ãŒã€ã“ã‚Œã¯ä¸€èˆ¬ã«$X$ã‚’å‹å¤‰æ•°ã¨ã—ã¦ã€å¼•æ•°$S[X]$ã‹ã‚‰å‹$T$ã‚’æ§‹ç¯‰ã™ã‚‹ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿$C : \forall X.\ (S[X] \rightarrow T)$ã®å‹ã‚’å¤‰å½¢ã™ã‚‹ã¨å­˜åœ¨å‹ã«ãªã£ã¦ã„ã‚‹ã¨ã‚ã‹ã‚Šã¾ã™ã€‚
$$\begin{aligned} & \forall X.\ (S[X] \rightarrow T) \\\ = \quad & (\exist X.\ S[X]) \rightarrow T \end{aligned}$$
ã®ã‚ˆã†ã«å¤‰å½¢ã§ãã¾ã™ã€‚

ã‚ã‚‹ã„ã¯å­˜åœ¨é‡åŒ–å­ãŒè¿½åŠ ã•ã‚ŒãŸRusté¢¨ã«æ›¸ãã¨ï¼ˆã‚ãã¾ã§é¢¨ã§ã™ï¼‰

```rust
enum Freer<F,A> {
    Return { returnValue: A },
    Freer (exists<X> { freerEffect: F<X>, resume: fn(X) -> Freer<F,A> })
}
```

ã¤ã¾ã‚Šã€$\mathrm{Freer}$ã¨ã¯$\mathrm{return}$ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã¨$\mathrm{freer}$ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã®ç›´å’Œã§ã™ã€‚

Extensible Effectsã®è¦³ç‚¹ã«ãŠã„ã¦ã¯ã€$\mathrm{Freer}[F,A]$ã¯å‹æ§‹ç¯‰å­$F : \mathrm{Type} \rightarrow \mathrm{Type}$ã§è¡¨ç¾ã•ã‚Œã‚‹ä¸€éšã®ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’ä¿æŒã—ã€å‹$A$ã‚’è¨ˆç®—ã®æœ€çµ‚çµæœã¨ã™ã‚‹ã‚¨ãƒ•ã‚§ã‚¯ãƒˆãƒ•ãƒ«ãªãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚³ãƒ¼ãƒ‰ï¼ˆæ‰‹ç¶šãï¼‰ã¨è¦‹ãªã›ã‚‹ã®ã§ã—ãŸã€‚$\mathrm{return}$ã¯ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’ä¸€åˆ‡ä¿æŒã—ã¦ãŠã‚‰ãšã€$A$å‹ã®ç´”ç²‹ãªè¨ˆç®—çµæœã®å€¤$\mathrm{returnValue}$ã®ã¿ã‚’ä¿æŒã—ã¦ã„ã‚‹çŠ¶æ…‹ã§ã™ã€‚ãã—ã¦$\mathrm{freer}$ã¯ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’å°‘ãªãã¨ã‚‚ä¸€ã¤ä»¥ä¸Šä¿æŒã—ã¦ã„ã‚‹çŠ¶æ…‹ã§ã™ã€‚ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã™ã¹ãç›´è¿‘ã®ã‚¨ãƒ•ã‚§ã‚¯ãƒˆãŒ$\mathrm{freerEffect}$ã«ä¿æŒã•ã‚Œã¦ãŠã‚Šã€ãã®ç¶™ç¶šã€ã™ãªã‚ã¡ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã®çµæœï¼ˆ$X$å‹ï¼‰ã‹ã‚‰ãã‚Œä»¥é™ã®æ‰‹ç¶šãã‚’æ±ºå®šã™ã‚‹é–¢æ•°ãŒ$\mathrm{resume}$ã«ä¿æŒã•ã‚Œã¦ã„ã¾ã™ã€‚

$\mathrm{Freer}$ã§è¡¨ç¾ã•ã‚ŒãŸã‚¨ãƒ•ã‚§ã‚¯ãƒˆãƒ•ãƒ«ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã¯ã€å˜ã«$\mathrm{Freer}$ã®ç›´å’Œã«å¯¾ã—ã¦ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒã™ã‚‹ã“ã¨ã§é”æˆã§ãã¾ã™ã€‚ã‚‚ã—$\mathrm{return}$ã ã£ãŸå ´åˆã€ä½•ã‚‚ã™ã‚‹ã“ã¨ãªãçµæœã®å€¤ãŒæ‰‹ã«å…¥ã‚Šã¾ã™ã€‚ã‚‚ã—$\mathrm{freer}$ã ã£ãŸå ´åˆã€$\mathrm{freerEffect}$ã«å¿œã˜ã¦å…·ä½“çš„ãªå‡¦ç†ï¼ˆãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ï¼‰ã‚’è¡Œã„ã€çµæœã‚’$\mathrm{resume}$ã«æ¸¡ã™ã¨æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã®$\mathrm{Freer}$ãŒæ‰‹ã«å…¥ã‚‹ã®ã§ã€ã“ã‚Œã‚’$\mathrm{return}$ãŒæ‰‹ã«å…¥ã‚‹ã¾ã§å†å¸°çš„ã«ç¹°ã‚Šè¿”ã›ã°ã‚ˆã„ã®ã§ã™ã€‚

ãƒ¡ãƒ³ã‚¿ãƒ«ãƒ¢ãƒ‡ãƒ«ã¨ã—ã¦ã¯ã€ã‚¨ãƒ•ã‚§ã‚¯ãƒˆãƒ•ãƒ«ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®å†…éƒ¨ã§ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ$\mathrm{freerEffect}$ãŒæŠ•ã’ã‚‰ã‚ŒãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§æ‰‹ç¶šããŒä¸€æ™‚ä¸­æ–­ã•ã‚Œã€ãƒãƒ³ãƒ‰ãƒ©ã«$\mathrm{freerEffect}$ã¨$\mathrm{resume}$ãŒæ¸¡ã£ã¦ãã¾ã™ã€‚ã“ã®ã¨ããƒãƒ³ãƒ‰ãƒ©ãŒå‡¦ç†ã—ãªã‘ã‚Œã°ãªã‚‰ãªã„ã‚‚ã®ãŒ$\mathrm{freerEffect}$ã§ã‚ã‚Šã€ãã®çµæœã‚’$\mathrm{resume}$ã«æ¸¡ã™ã¨ã€æ‰‹ç¶šãå´ã‹ã‚‰è¦‹ã‚‹ã¨ãƒãƒ³ãƒ‰ãƒ©ã‹ã‚‰çµæœãŒå¸°ã£ã¦ãã¦å‡¦ç†ã‚’å†é–‹ï¼ˆãƒ¬ã‚¸ãƒ¥ãƒ¼ãƒ ï¼‰ã§ãã‚‹ã€ã¨ã„ã†æµã‚Œã«ãªã‚Šã¾ã™ã€‚
ãƒãƒ³ãƒ‰ãƒ©ã¯$\mathrm{resume}$ã‚’å‘¼ã³å‡ºã•ãªã„ï¼ˆæ”¾æ£„ã™ã‚‹ï¼‰ã“ã¨ã‚‚ã§ãã¾ã™ã€‚ã“ã®å ´åˆã€ãã®ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‹ã‚‰æ‰‹ç¶šãã®æœ€å¾Œã¾ã§ã®å‡¦ç†ãŒã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã€ã„ã‚ã‚†ã‚‹å¤§åŸŸè„±å‡ºã®åˆ¶å¾¡æ§‹é€ ãŒå®Ÿç¾ã§ãã¾ã™ã€‚


ä»»æ„ã®$F : \mathrm{Type} \rightarrow \mathrm{Type}$ã«ã¤ã„ã¦ã€$\mathrm{Freer}[F]$ã¯ãƒ¢ãƒŠãƒ‰ã«ãªã‚Šã¾ã™:
$$\forall F : \mathrm{Type} \rightarrow \mathrm{Type}.\ \mathrm{Monad} \big[ \mathrm{Freer}[F] \big] .$$
ãƒ¢ãƒŠãƒ‰ã«ãªã‚‹ã¨ã„ã†ã“ã¨ã¯ã¤ã¾ã‚Šã€ç³–è¡£æ§‹æ–‡ï¼ˆdoè¨˜æ³•ï¼‰ã«ã‚ˆã£ã¦ã‚ãŸã‹ã‚‚æ™®é€šã®æ‰‹ç¶šãå‹è¨€èªã‚’ä½¿ã†ã‹ã®ã‚ˆã†ã«ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãã ã‘ã§ã€è‡ªå‹•çš„ã«ãã®ã‚¨ãƒ•ã‚§ã‚¯ãƒˆãƒ•ãƒ«ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®Freerã«ã‚ˆã‚‹è¡¨ç¾ãŒæ‰‹ã«å…¥ã‚‹ã¨ã„ã†ã“ã¨ã§ã™ã€‚

ä¸€æ–¹ã§ã€$\mathrm{Free}$ã¨ã„ã†ãƒ‡ãƒ¼ã‚¿æ§‹é€ ãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã¯

* å¸°ç´çš„å®šç¾©

    $$\begin{aligned}
    & \mathrm{Free}[F,A] \  \mathrm{where} \\\
    & \quad \mathrm{pure} : \{ \mathrm{pureValue}: A \} \rightarrow \mathrm{Free}[F,A] \\\
    & \quad \mathrm{free} : \big\{ \mathrm{freeEffect}: F \big[ \mathrm{Free}[F,A] \big] \big\} \rightarrow \mathrm{Free}[F,A]
    \end{aligned}
    $$

* ä¸å‹•ç‚¹ã«ã‚ˆã‚‹å®šç¾©

    $$
    \mathrm{Free}[F,A] := \mathrm{fix} \ \alpha. \ A + F[\alpha]
    $$

ã®ã‚ˆã†ã«å®šç¾©ã•ã‚Œã¾ã™ã€‚
Functorã§ã‚ã‚‹ã‚ˆã†ãªä»»æ„ã®$F : \mathrm{Type} \rightarrow \mathrm{Type}$ã«é™ã‚Šã€$\mathrm{Free}[F]$ã¯ãƒ¢ãƒŠãƒ‰ã«ãªã‚Šã¾ã™:
$$\forall F.\ \mathrm{Functor}[F] \implies \mathrm{Monad} \big[ \mathrm{Free}[F] \big] .$$

ã•ã‚‰ã«ã€$\mathrm{Coyoneda}$ã¨ã„ã†ãƒ‡ãƒ¼ã‚¿æ§‹é€ ãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã¯

$$ \mathrm{Coyoneda}[F,A] = \exists X.\ F[X] \times (X \rightarrow A) $$

ã¨å®šç¾©ã•ã‚Œã€ä»»æ„ã®$F : \mathrm{Type} \rightarrow \mathrm{Type}$ã«ã¤ã„ã¦Functorã«ãªã‚Šã¾ã™ã€‚

ãã—ã¦ã€$\mathrm{Freer}$ã¯$\mathrm{Free}$ã¨$\mathrm{Coyoneda}$ã‚’åˆæˆã™ã‚‹ã“ã¨ã§ä½œã‚Œã¾ã™:

$$\begin{aligned}
& \mathrm{Free}\big[\mathrm{Coyoneda}[F,-],A\big] \\\
& = \quad \mathrm{fix} \ \alpha. \ A + \mathrm{Coyoneda}[F,\alpha] & (\mathrm{Freeã‚’å±•é–‹}) \\\
& = \quad \mathrm{fix} \ \alpha. \ A + \big( \exists X.\ F[X] \times (X \rightarrow \alpha) \big) & (\mathrm{Coyonedaã‚’å±•é–‹}) \\\
& = \quad \mathrm{Freer}[F,A] \ . & (\mathrm{Freerã®ä¸å‹•ç‚¹ã«ã‚ˆã‚‹å®šç¾©ã‚ˆã‚Š})
\end{aligned}
$$

$\mathrm{Coyoneda}$ãŒä»»æ„ã®$F : \mathrm{Type} \rightarrow \mathrm{Type}$ã‚’Functorã«å¤‰æ›ã—ã¦ãã‚Œã‚‹ã®ã§ã€$\mathrm{Freer}$ã¯ç„¡æ¡ä»¶ã«Monadã«ãªã‚Šã¾ã™ã€‚ãã—ã¦ã€$F$ã«æ‹¡å¼µå¯èƒ½å’Œ (Open Union) ã‚’ä½¿ã†ã“ã¨ã§ã€è¤‡æ•°ã®ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’åŒæ™‚ã«æ‰±ãˆã‚‹ã‚ˆã†ã«ãªã‚Šã€å‹ãƒ¬ãƒ™ãƒ«ãƒªã‚¹ãƒˆã‚’ç”¨ã„ã¦ã‚¨ãƒ•ã‚§ã‚¯ãƒˆé›†åˆã‚’è¡¨ç¾ã™ã‚‹ã“ã¨ã§ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚·ã‚¹ãƒ†ãƒ ã®ã‚¨ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆãŒå¯èƒ½ã«ãªã‚‹ã®ã§ã—ãŸã€‚

# é«˜éšã‚¨ãƒ•ã‚§ã‚¯ãƒˆã¸ã®æ‹¡å¼µ

ã“ã“ã§ã€ãŠã‚‚ã‚€ã‚ã«Freerã‚’ä»¥ä¸‹ã®ã‚ˆã†ãªå®šç¾©ã«å¤‰æ›´ã—ã¦ã¿ã¾ã™ã€‚

$$\begin{aligned}
& \mathrm{Freer'}[H,M,A] \  \mathrm{where} \\\
& \quad \mathrm{return} : \{ \mathrm{returnValue}: A \} \rightarrow \mathrm{Freer'}[H,M,A] \\\
& \quad \mathrm{freer} : \big( \exist X. \{ \mathrm{freerEffect}: H[\mathrm{Freer'}[H,M,-],X], \mathrm{resume}: X \rightarrow \mathrm{Freer'}[H,M,A] \} \big) \\\
& \quad\quad\quad\quad \rightarrow \mathrm{Freer'}[H,M,A]
\end{aligned}
$$
